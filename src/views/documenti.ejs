<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Documenti - Vercam</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <link href="/stylesheets/navbar.css" rel="stylesheet">
  <link href="/stylesheets/footer.css" rel="stylesheet">
  <link href="/stylesheets/hero.css" rel="stylesheet">
  <link href="/stylesheets/documenti.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" defer></script>
  <script src="/javascripts/documenti.js" defer></script>
</head>
<body>

  <%- include('partials/navbar') %>
    <section class="hero-section-doc bg-success text-white py-5">
  <div class="container">
    <div class="row align-items-center min-vh-75">
      <div class="col-12 text-center">
                <!-- Page title -->
                <h1 class="display-4 fw-bold mb-3 text-shadow">Documenti</h1>
                <p class="lead">Scarica le procedure, modulistica e documenti utili.</p>
                        <div class="d-grid gap-2 d-md-flex justify-content-md-center">
          <a href="#documenti" class="btn btn-light btn-lg px-4 py-3 fw-bold shadow">
            <i class="bi bi-file-earmark-text me-2"></i>Esplora documenti
          </a>
        </div>
            </div>
        </div>
          <div class="particles-bg">
    <div class="particle" style="width: 30px; height: 30px; top: 20%; left: 10%; animation-delay: 0s;"></div>
    <div class="particle" style="width: 20px; height: 20px; top: 60%; left: 80%; animation-delay: 1s;"></div>
    <div class="particle" style="width: 25px; height: 25px; top: 40%; left: 70%; animation-delay: 2s;"></div>
    <div class="particle" style="width: 15px; height: 15px; top: 80%; left: 20%; animation-delay: 0.5s;"></div>
  </div>        

    </div>
    </section>

        <main class="container-fluid px-3 px-md-4 py-5 documenti-main-container" id="documenti">
                <!-- Barra di ricerca (seguo struttura di documenti.html) -->
                <div class="doc-search-box mb-4">
                    <div class="doc-search-wrapper mx-auto">
                        <input type="search" id="docSearch" name="q" class="doc-search-input form-control form-control-lg" placeholder="Cerca un documento..." value="<%= query && query.q ? query.q : '' %>">
                        <button type="button" class="doc-search-btn btn btn-success" aria-label="Cerca" id="docSearchBtn">
                            <i class="bi bi-search"></i>
                        </button>
                    </div>
                </div>

                <!-- Filtri per categoria (stessa struttura e ID usati nello statico) -->
                <div class="filters-section mb-4">
                    <div class="row g-3 align-items-end justify-content-center">
                        <div class="col-12 col-md-auto">
                            <label for="categoryFilter" class="form-label fw-bold mb-2 mb-md-0">Filtra per categoria:</label>
                        </div>
                        <div class="col-12 col-md-auto">
                            <select class="form-select" id="categoryFilter" name="category">
                                <option value="">Tutte le categorie</option>
                                <% Object.keys(groupedDocuments || {}).forEach(function(cat){ %>
                                    <option value="<%= cat %>" <%= (query && query.category === cat) ? 'selected' : '' %>><%= cat.charAt(0).toUpperCase() + cat.slice(1) %></option>
                                <% }) %>
                            </select>
                        </div>
                        <div class="col-12 col-md-auto">
                            <button type="button" class="btn btn-outline-secondary w-100" id="clearDocFilters">
                                <i class="bi bi-x-circle me-1"></i>Pulisci filtri
                            </button>
                        </div>
                    </div>
                </div>

        <!-- Sezione documenti dinamici (popolata da server-side rendering) -->
        <div id="documentsContainer">
          <% 
               // Helper: consider documents "Nuovo" if uploaded within the last N days
               const NEW_WINDOW_DAYS = 6;
               function isNewDate(uploadDate) {
                   try {
                       if (!uploadDate) return false;
                       const parts = String(uploadDate).split('/'); // expected DD/MM/YYYY
                       if (parts.length !== 3) return false;
                       const iso = parts[2] + '-' + parts[1] + '-' + parts[0];
                       const d = new Date(iso);
                       const now = new Date();
                       const diffDays = Math.ceil((now - d) / (1000 * 60 * 60 * 24));
                       return diffDays <= NEW_WINDOW_DAYS;
                   } catch (e) {
                       return false;
                   }
               }
               
               function getCategoryBadgeClass(cat) {
                 const map = {
                   'contratti': 'bg-success',
                   'certificati': 'bg-info',
                   'manuali': 'bg-warning',
                   'procedure': 'bg-secondary',
                   'modulistica': 'bg-primary',
                   'altro': 'bg-dark'
                 };
                 return map[cat] || 'bg-secondary';
               }
               
               function getDocIcon(category) {
                 const map = {
                   'contratti': 'bi-file-earmark-text',
                   'certificati': 'bi-file-earmark-check',
                   'manuali': 'bi-file-earmark-ruled',
                   'procedure': 'bi-file-earmark-text',
                   'modulistica': 'bi-file-earmark-word',
                   'altro': 'bi-file-earmark-presentation'
                 };
                 return map[category] || 'bi-file-earmark-text';
               }
          %>
          <% if (!groupedDocuments || Object.keys(groupedDocuments).length === 0) { %>
              <!-- Nessun documento -->
          <% } else { %>
              <% Object.keys(groupedDocuments).forEach(function(category, idx){
                       const docs = groupedDocuments[category] || [];
                       const collapseId = 'category-' + category;
                       const badgeClass = getCategoryBadgeClass(category);
                       const categoryName = category.charAt(0).toUpperCase() + category.slice(1);
              %>
                  <div class="category-section mb-4">
                      <div class="category-header d-flex flex-column flex-sm-row align-items-start align-items-sm-center justify-content-between p-3 bg-light rounded shadow-sm" data-bs-toggle="collapse" data-bs-target="#<%= collapseId %>" style="cursor: pointer;">
                          <div class="d-flex flex-column flex-sm-row align-items-start align-items-sm-center mb-2 mb-sm-0">
                              <h3 class="mb-2 mb-sm-0 me-sm-3 h4"><%= categoryName %></h3>
                              <span class="badge <%= badgeClass %>"><%= docs.length %> documento<%= docs.length !== 1 ? 'i' : '' %></span>
                          </div>
                          <i class="bi bi-chevron-down category-chevron align-self-end align-self-sm-center"></i>
                      </div>

                      <div id="<%= collapseId %>" class="collapse <%= idx === 0 ? 'show' : '' %> mt-3">
                          <div class="row g-3 g-md-4">
                              <% docs.forEach(function(doc){ 
                                   const isNew = isNewDate(doc.uploadDate);
                                   const icon = getDocIcon(category);
                              %>
                                  <div class="col-12 col-md-6 col-lg-6 col-xl-4">
                                      <div class="card h-100 shadow-sm border-0 <%= isNew ? 'border-danger' : '' %>" <%= isNew ? 'style="border-width: 2px;"' : '' %>>
                                          <div class="card-body d-flex flex-column">
                                              <div class="d-flex align-items-start mb-3">
                                                  <i class="bi <%= icon %> fs-2 text-success me-3 flex-shrink-0"></i>
                                                  <div class="flex-grow-1 min-w-0">
                                                      <h5 class="card-title mb-1 d-flex align-items-center flex-wrap">
                                                          <span class="text-truncate"><%= doc.name %></span>
                                                          <% if (isNew) { %>
                                                              <span class="badge bg-danger ms-2">Nuovo</span>
                                                          <% } %>
                                                      </h5>
                                                      <% if (doc.description) { %>
                                                          <p class="card-text text-muted small mb-2"><%= doc.description %></p>
                                                      <% } %>
                                                      <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
                                                          <span class="badge <%= badgeClass %>"><%= categoryName %></span>
                                                          <% if (doc.size) { %><small class="text-muted"><%= doc.size %></small><% } %>
                                                      </div>
                                                  </div>
                                              </div>

                                              <div class="mt-auto">
                                                  <div class="d-flex flex-column flex-sm-row justify-content-between align-items-start align-items-sm-center gap-2">
                                                      <small class="text-muted">Caricato: <%= doc.uploadDate %></small>
                                                      <% if (doc.path) { %>
                                                          <% const href = doc.path.startsWith('/') ? doc.path : '/' + doc.path; %>
                                                          <a class="btn btn-success btn-sm w-100 w-sm-auto" href="<%= href %>" target="_blank" rel="noopener noreferrer">
                                                            <i class="bi bi-download me-1"></i>Scarica
                                                          </a>
                                                      <% } else { %>
                                                          <button class="btn btn-secondary btn-sm w-100 w-sm-auto" disabled><i class="bi bi-download me-1"></i>Scarica</button>
                                                      <% } %>
                                                  </div>
                                              </div>
                                          </div>
                                      </div>
                                  </div>
                              <% }) %>
                          </div>
                      </div>
                  </div>
              <% }) %>
          <% } %>
        </div>

        <!-- Messaggio quando non ci sono documenti -->
        <div id="noDocumentsMessage" class="text-center py-5 px-3" style="display: none;">
          <i class="bi bi-file-earmark-x fs-1 text-muted mb-3"></i>
          <h4 class="text-muted h5">Nessun documento disponibile</h4>
          <p class="text-muted small">I documenti verranno pubblicati a breve nell'area riservata.</p>
        </div>
    </main>

    <footer class="footer position-relative py-5 text-white">
      <div class="footer-bg-gradient position-absolute top-0 start-0 w-100 h-100 z-0"></div>
      <div class="particles-bg">
        <div class="particle particle-f1"></div>
        <div class="particle particle-f2"></div>
        <div class="particle particle-f3"></div>
        <div class="particle particle-f4"></div>
        <div class="particle particle-f5"></div>
      </div>
      <div class="container position-relative z-2">
        <div class="row gy-4">
          <!-- Contact Form Column -->
          <div class="col-lg-6 mb-4 mb-lg-0">
            <div class="footer-card p-4 shadow-lg">
              <h5 class="mb-4 text-center overflow-hidden">Contattaci</h5>
              <form id="emailForm" action="" method="POST">
                <div class="row g-3 mb-3">
                  <div class="col-sm-6">
                    <input type="text" class="form-control" placeholder="Nome e Cognome" name="name" required>
                  </div>
                  <div class="col-sm-6">
                    <input type="email" class="form-control" placeholder="Email" name="email" required>
                  </div>
                </div>
                <div class="mb-3">
                  <input type="text" class="form-control" placeholder="Oggetto" name="subject" required>
                </div>
                <div class="mb-4">
                  <textarea class="form-control" placeholder="Messaggio" name="message" rows="4" required></textarea>
                </div>
                <div class="text-center">
                  <button type="submit" class="btn btn-light px-4 py-2">Invia Messaggio</button>
                </div>
              </form>
            </div>
          </div>
          <!-- Info Column -->
          <div class="col-lg-6 text-center m-auto">
            <div class="footer-card p-4 shadow-lg">
              <h5 class="mb-4 text-center overflow-hidden">Vercam</h5>
              <div class="d-flex flex-column align-items-center mb-4">
                <p class="mb-3"><i class="bi bi-geo-alt-fill me-2"></i> Via dello Sport 123, Borgo Vercelli (VC)</p>
                <p class="mb-3"><i class="bi bi-telephone-fill me-2"></i> +39 0123 456789</p>
                <p class="mb-3"><i class="bi bi-envelope-fill me-2"></i> info@asdborgovercelli.it</p>
              </div>
              <!-- Social Media Icons -->
              <div class="text-center mb-4">
                <a href="#" class="text-white mx-2"><i class="bi bi-facebook fs-4"></i></a>
                <a href="#" class="text-white mx-2"><i class="bi bi-instagram fs-4"></i></a>
                <a href="#" class="text-white mx-2"><i class="bi bi-twitter-x fs-4"></i></a>
              </div>
            </div>
          </div>
        </div>
        <!-- Copyright -->
        <div class="row mt-5">
          <div class="col-12 text-center">
            <hr class="my-4 bg-light opacity-50">
            <p class="mb-0">&copy; Vercam. Tutti i diritti riservati.</p>
          </div>
        </div>
      </div>
    </footer>
</body>
</html>